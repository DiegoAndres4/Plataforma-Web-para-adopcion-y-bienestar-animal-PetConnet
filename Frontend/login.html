<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PetConnect - Login</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Tus estilos -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/login.css">
</head>
<body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg site-navbar bg-white">
        <div class="container">
            <a class="navbar-brand logo" href="index.html">
                <img src="img/logo.png" alt="PetConnect">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
                    aria-controls="mainNav" aria-expanded="false" aria-label="Alternar navegaci贸n">
                <span class="navbar-toggler-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Abrir men煤</span>
            </button>
            <div class="collapse navbar-collapse" id="mainNav">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center">
                    <li class="nav-item"><a class="nav-link" href="adopcion.html">Adopci贸n</a></li>
                    <li class="nav-item"><a class="nav-link" href="denuncias.html">Denuncias</a></li>
                    <li class="nav-item"><a class="nav-link" href="acerca.html">Acerca de</a></li>
                    <li class="nav-item"><a class="nav-link" href="Contactenos.html">Contacto</a></li>
                    <li class="nav-item"><a class="nav-link btn login-btn text-white ms-lg-3" href="login.html">Login</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- CONTENIDO LOGIN -->
    <div class="login-container">
        <div class="login-box">
            <div class="illustration-placeholder">
                <img src="img/login-mascotas.png" alt="Mascotas felices">
            </div>

            <h1>Acceso Seguro</h1>
            <p class="subtitle">Inicia sesi贸n en tu cuenta para empezar tu viaje con PetConnect.</p>

            <form id="loginForm">
                <div class="form-group">
                    <div class="input-wrapper">
                        <span class="input-icon"></span>
                        <input type="text" id="username" placeholder="Username" required>
                    </div>
                </div>

                <div class="form-group">
                    <div class="input-wrapper">
                        <span class="input-icon"></span>
                        <input type="password" id="password" placeholder="Contrase帽a" required>
                    </div>
                </div>

                <div class="remember-forgot">
                    <label class="remember-me">
                        <input type="checkbox" id="remember">
                        <span>Recordarme</span>
                    </label>
                    <a href="#" class="forgot-password">驴Olvidaste tu contrase帽a?</a>
                </div>

                <button type="submit" class="submit-btn">Iniciar Sesi贸n</button>
            </form>

            <p class="register-link">
                驴No tienes cuenta? <a href="registro.html">Reg铆strate aqu铆.</a>
            </p>

            <div class="security-note">
                <span class="security-icon"></span>
                <span>Conexi贸n segura garantizada. Protocolos HTTPS.</span>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 PetConnect. Todos los derechos reservados.</p>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- LGICA DE LOGIN ADAPTABLE -->
    <script>
        const LOGIN_API = "http://localhost:5054/v2/authenticate";

        // Funci贸n para decodificar JWT sin librer铆as
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error("Error al decodificar JWT:", e);
                return null;
            }
        }

        document.getElementById('loginForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const remember = document.getElementById('remember').checked;

            if (!username || !password) {
                alert("Por favor ingresa tu usuario y contrase帽a.");
                return;
            }

            try {
                console.log("Enviando:", { username, password });
                
                const resp = await fetch(LOGIN_API, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ username, password })
                });

                console.log("Status HTTP:", resp.status);

                if (!resp.ok) {
                    alert("Usuario o contrase帽a incorrectos.");
                    return;
                }

                const data = await resp.json();
                console.log("Respuesta del backend:", data);

                // El backend devuelve { "jwt": "..." }
                if (!data.jwt) {
                    alert("Error: No se recibi贸 el token de autenticaci贸n.");
                    return;
                }

                // Decodificar el JWT para obtener informaci贸n del usuario
                const jwtPayload = parseJwt(data.jwt);
                console.log("Payload del JWT:", jwtPayload);

                // Guardar datos en localStorage
                localStorage.setItem("isLoggedIn", "true");
                localStorage.setItem("authToken", data.jwt);
                localStorage.setItem("userName", jwtPayload.sub); // username est谩 en "sub"
                localStorage.setItem("userRoles", JSON.stringify(jwtPayload.roles || []));

                if (remember) {
                    localStorage.setItem("rememberMe", "true");
                }

                alert("隆Bienvenido a PetConnect, " + jwtPayload.sub + "!");
                window.location.href = "dashboard.html";

            } catch (error) {
                console.error("Error al hacer login:", error);
                alert("Ocurri贸 un error al intentar iniciar sesi贸n.");
            }
        });
    </script>
</body>
</html>